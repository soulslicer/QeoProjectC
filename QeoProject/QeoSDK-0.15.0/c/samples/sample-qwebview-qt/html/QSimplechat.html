<html>
<head>
<script src="jquery.js"></script> <!--  needed for this sample, not for qeo itself -->
<script src="qeo.js"></script> <!--  load qeo library -->
<script src="QSimpleChat_ChatMessage.js"></script> <!-- Load qeo types. Generated by qeo-codegen. -->
<script src="QeoManifest-QSimplechat.js"></script> <!-- Load the manifest for this sample -->

<script type="text/javascript">


//----------------------------------
// Wait until document is ready
//----------------------------------
$(document).ready(function() {
    var factoryOptions = {"manifest": org_qeo_sample_simplechat_ChatMessage_Manifest};
    
    //create a Qeo factory. Pass the manifest file as an option.
    Qeo.createFactory(factoryOptions).then(function(factory){
        //creation of the factory is asynchronous and will enter here is created.
        
        //now create the readers and writer.
        //this also is asynchronous and will return a promise.
        var promisedWriter = factory.createEventWriter("org::qeo::sample::simplechat::ChatMessage");
        var promisedReader = factory.createEventReader("org::qeo::sample::simplechat::ChatMessage");

        promisedWriter.then(function(writer) {
            //writer is created.
            $("#send").click(function() {
                //add hook to the send button.
                var data = { 'from' : $('#who').val(), 'message' : $('#text').val() };
                writer.write(data);
                $("#text").val("");
            });
        }, function(error) {
            //error in writer creation.
            console.error(error);
            alert(error);
        });
        
        promisedReader.then(function(reader) {
            //reader is created.
            reader.on("data",function (data) {
                //handle read events.
                $('#output').append('<div class="message"><span class="username">' + data.from + '</span><span class="messagetext">'+data.message+'</span></div>');
                $('#output').scrollTop($('#output').get(0).scrollHeight);
            });
        }, function(error) {
            //error in reader creation.
            console.error(error);
            alert(error);
        });
    }, function(error) {
        //error in factory creation.
        console.error(error);
        alert(error);
    });
});
//----------------------------------
// Reload document => cleanup
//----------------------------------
$(window).bind('beforeunload',function(){
   Qeo.cleanup();
});

</script>

<style>
    .username {
        color: blue;
        font-weight: bold;
    }
    .messagetext {
        color: black;
    }
    .message {
        border: solid 1px black;
    }
    span {
        display: inline-block;
        *display: inline;/* for IE7*/
        *zoom:1;/* for IE7*/
        width: auto !important;
        width 150px;
        min-width: 150px;
    }
</style>
</head>

<body>
<div id="input" style="clear:both;">
    User <input id="who" type="text" value="WebViewUser"/>
    Message <input id="text" type="text" style="width:80%;"/>
    <button id="send">Send</button>
</div>
<hr/>
<div id="output" style="border:solid black; padding: 10px; overflow-y:auto; margin:0px; margin-bottom: 5px; height: 60%;">
    <div class="message">
        <span class="username">FROM</span><span class="messagetext">MESSAGE</span>
    </div>
</div>
</body>
</html>

